<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Garry</title>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --primary: #2196f3;
  --danger: #e53935;
  --success: #43a047;
  --text: #111;
  --border: #ddd;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: white;
  border-bottom: 1px solid var(--border);
}

header img {
  height: 40px;
}

#main {
  display: flex;
  height: calc(100vh - 65px);
}

#left {
  width: 25%;
  background: var(--card);
  padding: 15px;
  border-right: 1px solid var(--border);
}

#right {
  width: 75%;
  display: flex;
  flex-direction: column;
  padding: 15px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
}

#messages {
  flex: 1;
  overflow-y: auto;
}

.message {
  padding: 6px;
  border-bottom: 1px solid var(--border);
}

input, button {
  padding: 10px;
  margin-top: 6px;
  width: 100%;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 14px;
}

button {
  cursor: pointer;
}

.primary { background: var(--primary); color: white; }
.success { background: var(--success); color: white; }
.danger  { background: var(--danger);  color: white; }

.controls {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

video {
  width: 49%;
  background: black;
  border-radius: 8px;
}

/* POPUPS */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.popupContent {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 320px;
}
</style>
</head>

<body>

<!-- POPUP BIENVENUE -->
<div class="popup" id="welcomePopup">
  <div class="popupContent">
    <h2>SOCO TV 2 devient Garry</h2>
    <p>Une messagerie made by SOCO</p>
    <button class="primary" onclick="closeWelcome()">Continuer</button>
  </div>
</div>

<!-- POPUP PSEUDO -->
<div class="popup" id="callPopup" style="display:none">
  <div class="popupContent">
    <h3>Ton pseudo</h3>
    <input id="pseudoInput" placeholder="Pseudo">
    <button class="primary" onclick="confirmCall()">DÃ©marrer lâ€™appel</button>
  </div>
</div>

<header>
  <img src="logo.png">
  <h2>Garry</h2>
</header>

<div id="main">

<div id="left">
  <div class="card">
    <button class="success" onclick="openCallPopup(true)">ðŸŽ¥ Appel vidÃ©o</button>
    <button class="success" onclick="openCallPopup(false)">ðŸ“ž Appel audio</button>
  </div>

  <div class="card">
    <h4>Messages</h4>
    <input id="messageInput" placeholder="Message libre">
    <button onclick="sendMessage()">Envoyer</button>
  </div>
</div>

<div id="right">
  <div class="card" id="messages"></div>

  <div class="card">
    <div style="display:flex; gap:6px">
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
    </div>

    <div class="controls">
      <button onclick="toggleMic()">ðŸŽ¤ Micro</button>
      <button onclick="toggleCam()">ðŸŽ¥ CamÃ©ra</button>
      <button class="danger" onclick="hangUp()">â›” Raccrocher</button>
    </div>
  </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ðŸ”¥ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "TON_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  databaseURL: "https://TON_PROJET.firebaseio.com",
  projectId: "TON_PROJET",
  storageBucket: "TON_PROJET.appspot.com",
  messagingSenderId: "ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pc, localStream, isVideo = true;
let micOn = true, camOn = true;

/* BIENVENUE */
function closeWelcome() {
  welcomePopup.style.display = "none";
}

/* CHAT */
function sendMessage() {
  if (!messageInput.value) return;
  db.ref("messages").push({ text: messageInput.value });
  messageInput.value = "";
}

db.ref("messages").on("child_added", s => {
  const d = document.createElement("div");
  d.className = "message";
  d.textContent = s.val().text;
  messages.appendChild(d);
});

/* APPELS */
function openCallPopup(video) {
  isVideo = video;
  callPopup.style.display = "flex";
}

function confirmCall() {
  callPopup.style.display = "none";
  startCall();
}

async function startCall() {
  pc = new RTCPeerConnection();
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:isVideo });
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  localVideo.srcObject = localStream;

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref("call").set({ offer });
}

db.ref("call").on("value", async s => {
  if (!s.exists() || pc) return;

  pc = new RTCPeerConnection();
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  localVideo.srcObject = localStream;

  await pc.setRemoteDescription(s.val().offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("call/answer").set(answer);
});

db.ref("call/answer").on("value", async s => {
  if (s.exists() && pc) await pc.setRemoteDescription(s.val());
});

/* CONTROLES */
function toggleMic() {
  micOn = !micOn;
  localStream.getAudioTracks()[0].enabled = micOn;
}

function toggleCam() {
  if (!localStream.getVideoTracks()[0]) return;
  camOn = !camOn;
  localStream.getVideoTracks()[0].enabled = camOn;
}

function hangUp() {
  pc?.close();
  localStream?.getTracks().forEach(t => t.stop());
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  pc = null;
  db.ref("call").remove();
}
</script>

</body>
</html>
