<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Garry - SOCO TV 2</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body {font-family:Arial,sans-serif;margin:0;padding:0;background:#f2f2f2;color:#222;}
#popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;color:white;font-size:1.5rem;z-index:1000;}
#main{max-width:1200px;margin:auto;padding:20px;background:white;box-shadow:0 0 10px rgba(0,0,0,0.2);border-radius:10px;}
#logo{max-width:200px;display:block;margin:auto;}
#usersList{border:1px solid #ccc;padding:10px;background:#fafafa;border-radius:5px;margin-bottom:10px;max-height:150px;overflow-y:auto;}
#chat{border:1px solid #ccc;height:200px;overflow-y:auto;padding:10px;margin-bottom:10px;background:#fafafa;border-radius:5px;}
#messages{width:calc(100% - 110px);padding:8px;}
#sendBtn{width:100px;padding:8px;}
#callArea{display:none;flex-direction:column;align-items:center;gap:10px;margin-top:20px;}
video{width:300px;height:225px;background:black;border-radius:5px;}
button{padding:8px 12px;margin:2px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
#mobileBtn{display:none;position:fixed;bottom:10px;right:10px;z-index:100;}
@media(max-width:768px){#mobileBtn{display:block;} video{width:100%;height:auto;}}
</style>
</head>
<body>

<div id="popup">
  SOCO TV 2 revient bientôt !
  Nous essayons de le faire revenir le plus vite possible, désolé pour avoir mis Garry ici. PS : Celui qui a copié collé le code n'est pas très voilà.
</div>

<div id="main">
  <img src="logo.png" id="logo" alt="Logo SOCO TV 2">

  <div id="usersList"></div>

  <div id="chat">
    <input type="text" id="messages" placeholder="Nous sommes désolé mais Garry (expérimental) sera déplacé et refait. Le code à été copié collé sans mettre l'id du système de messages.">
  </div>

  <div id="callArea">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <div>
      <button onclick="toggleMic()">Micro</button>
      <button onclick="toggleCam()">Caméra</button>
      <button onclick="hangUp()">Raccrocher</button>
    </div>
  </div>

  <button id="mobileBtn" onclick="enableMobile()">Mode Mobile</button>
</div>

<script>
let userID=localStorage.getItem('garryID');
if(!userID){userID=crypto.randomUUID(); localStorage.setItem('garryID',userID);}
let pseudo=localStorage.getItem('garryPseudo')||'Garry'+userID.slice(0,4);
document.getElementById('pseudoInput').value=pseudo;

function closePopup(){
  pseudo=document.getElementById('pseudoInput').value||pseudo;
  localStorage.setItem('garryPseudo',pseudo);
  document.getElementById('popup').style.display='none';
  init();
}

function enableMobile(){document.body.style.width='360px';document.body.style.margin='auto';}

// Firebase Config
const firebaseConfig={
  apiKey:"TON_API_KEY",
  authDomain:"TON_PROJET.firebaseapp.com",
  databaseURL:"https://TON_PROJET.firebaseio.com",
  projectId:"TON_PROJET",
  storageBucket:"TON_PROJET.appspot.com",
  messagingSenderId:"ID",
  appId:"APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let localStream, peerConnection;
const config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
const localVideo=document.getElementById('localVideo');
const remoteVideo=document.getElementById('remoteVideo');
let currentCallID=null;

function init(){
  const usersRef=db.ref('users');
  usersRef.child(userID).set({pseudo:pseudo,online:true});
  usersRef.child(userID).onDisconnect().remove();

  const usersList=document.getElementById('usersList');
  usersRef.on('value', snapshot=>{
    usersList.innerHTML='Utilisateurs en ligne:<br>';
    snapshot.forEach(child=>{
      const u=child.val();
      if(child.key!==userID){
        const btn=document.createElement('button');
        btn.textContent='Appeler '+u.pseudo;
        btn.onclick=()=>startCall(child.key);
        usersList.appendChild(btn);
        usersList.appendChild(document.createElement('br'));
      }
    });
  });

  // Chat synchronisé
  const chatBox=document.getElementById('chat');
  const messagesInput=document.getElementById('messages');
  const sendBtn=document.getElementById('sendBtn');
  sendBtn.onclick=()=>{
    if(messagesInput.value.trim()!==''){
      db.ref('messages').push({from:pseudo,text:messagesInput.value,timestamp:Date.now()});
      messagesInput.value='';
    }
  };

  db.ref('messages').off(); // supprime anciens listeners
  db.ref('messages').on('child_added', snapshot=>{
    const data=snapshot.val();
    const msg=document.createElement('div');
    msg.textContent=(data.from||'Anonyme')+': '+data.text;
    chatBox.appendChild(msg);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

// Appel WebRTC ciblé
async function startCall(targetID){
  document.getElementById('callArea').style.display='flex';
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
  peerConnection=new RTCPeerConnection(config);
  localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
  peerConnection.ontrack=e=>{remoteVideo.srcObject=e.streams[0];};
  const callID=userID+'_'+targetID;
  currentCallID=callID;
  const callRef=db.ref('calls/'+callID);
  peerConnection.onicecandidate=event=>{if(event.candidate){callRef.child('candidates').push(event.candidate.toJSON());}};
  const offer=await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  await callRef.set({from:userID,to:targetID,offer:offer.toJSON()});
  callRef.on('value',async snapshot=>{
    const data=snapshot.val();
    if(data?.answer && !peerConnection.currentRemoteDescription){
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });
  callRef.child('candidates').on('child_added',snapshot=>peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val())));
}

// Recevoir les appels
db.ref('calls').on('child_added',async snapshot=>{
  const data=snapshot.val();
  if(data.to===userID && !currentCallID){
    if(confirm(data.from+' vous appelle, acceptez ?')){
      document.getElementById('callArea').style.display='flex';
      currentCallID=snapshot.key;
      localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      localVideo.srcObject=localStream;
      peerConnection=new RTCPeerConnection(config);
      localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
      peerConnection.ontrack=e=>{remoteVideo.srcObject=e.streams[0];};
      peerConnection.onicecandidate=event=>{if(event.candidate){db.ref('calls/'+currentCallID+'/candidates').push(event.candidate.toJSON());}};
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer=await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      db.ref('calls/'+currentCallID+'/answer').set(answer.toJSON());
      db.ref('calls/'+currentCallID+'/candidates').on('child_added',snapshot=>peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val())));
    } else {snapshot.ref.remove();}
  }
});

// Contrôles
function hangUp(){if(peerConnection){peerConnection.close(); peerConnection=null;} if(localStream){localStream.getTracks().forEach(t=>t.stop()); localStream=null;} remoteVideo.srcObject=null; localVideo.srcObject=null; document.getElementById('callArea').style.display='none'; currentCallID=null;}
function toggleMic(){if(localStream)localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled;}
function toggleCam(){if(localStream)localStream.getVideoTracks()[0].enabled=!localStream.getVideoTracks()[0].enabled;}
</script>
</body>
</html>
