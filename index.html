<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Garry</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f0f0f;
  color: white;
}

header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: #1b1b1b;
}

header img {
  height: 45px;
}

#main {
  display: flex;
  height: calc(100vh - 65px);
}

#left {
  width: 25%;
  background: #161616;
  padding: 10px;
  border-right: 1px solid #333;
}

#right {
  width: 75%;
  display: flex;
  flex-direction: column;
  padding: 10px;
}

#messages {
  flex: 1;
  border: 1px solid #333;
  padding: 10px;
  overflow-y: auto;
  margin-bottom: 10px;
}

input, button {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  background: #222;
  border: 1px solid #444;
  color: white;
}

button {
  cursor: pointer;
}

button.audio { background: #4caf50; }
button.video { background: #2196f3; }

video {
  width: 48%;
  background: black;
  margin-top: 5px;
}

/* POPUP */
#popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
}

#popupContent {
  background: #1e1e1e;
  padding: 20px;
  border: 1px solid #444;
  width: 300px;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Garry">
  <h2>Garry</h2>
</header>

<div id="main">

<div id="left">
  <h3>Appels</h3>
  <button class="audio" onclick="openPopup(false)">ðŸ“ž Appel audio</button>
  <button class="video" onclick="openPopup(true)">ðŸŽ¥ Appel vidÃ©o</button>
</div>

<div id="right">
  <div id="messages"></div>
  <input id="messageInput" placeholder="Message (sans connexion)">
  <button onclick="sendMessage()">Envoyer</button>

  <div style="display:flex; gap:5px;">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
</div>

</div>

<!-- POPUP LOGIN -->
<div id="popup">
  <div id="popupContent">
    <h3>Entrer ton pseudo</h3>
    <input id="pseudoInput" placeholder="Pseudo">
    <button onclick="confirmCall()">Confirmer</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ðŸ”¥ CONFIG FIREBASE (Ã€ REMPLACER)
const firebaseConfig = {
  apiKey: "TON_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  databaseURL: "https://TON_PROJET.firebaseio.com",
  projectId: "TON_PROJET",
  storageBucket: "TON_PROJET.appspot.com",
  messagingSenderId: "ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pc = null;
let localStream = null;
let pseudo = "";
let callWithVideo = false;

const messagesRef = db.ref("messages");

// ðŸ’¬ CHAT SANS CONNEXION
function sendMessage() {
  const text = messageInput.value;
  if (!text) return;
  messagesRef.push({ text });
  messageInput.value = "";
}

messagesRef.on("child_added", snap => {
  const div = document.createElement("div");
  div.textContent = snap.val().text;
  messages.appendChild(div);
});

// ðŸ“ž POPUP
function openPopup(video) {
  callWithVideo = video;
  popup.style.display = "flex";
}

function confirmCall() {
  pseudo = pseudoInput.value;
  if (!pseudo) return alert("Pseudo requis");
  popup.style.display = "none";
  startCall(callWithVideo);
}

// ðŸŽ¥ðŸ“ž WEBRTC
async function startCall(video) {
  pc = new RTCPeerConnection();

  localStream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: video
  });

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  localVideo.srcObject = localStream;

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref("call").set({ offer, pseudo });
}

db.ref("call").on("value", async snap => {
  if (!snap.exists() || pc) return;

  pc = new RTCPeerConnection();
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  localVideo.srcObject = localStream;

  await pc.setRemoteDescription(snap.val().offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("call/answer").set(answer);
});

db.ref("call/answer").on("value", async snap => {
  if (snap.exists() && pc) {
    await pc.setRemoteDescription(snap.val());
  }
});
</script>

</body>
</html>
